import{d as ge,aH as _e,r as i,a2 as A,o as ye,a as f,k as he,g as ke,f as Z,i as l,w as a,l as u,n as be,az as M,aW as G,b as B,aA as we,aB as w,e as c,m as Ce,c as D,aC as Ve,D as W,aF as C,aI as xe,N as Re}from"./index-d0b35c07.js";import{a as J,c as Ee}from"./index-85939620.js";import{m as Ne}from"./index-adf42357.js";import{r as X,u as Y,a as ee,g as Se,d as Ie,b as Ue}from"./system-6b6c2e6e.js";const Ae={class:"app-container"},Me={class:"search"},Be={class:"dialog-footer"},De=ge({name:"RoleManage",__name:"index",setup(Ke,{expose:le}){const $=_e(),q=i(M),N=i(M);i(G);const V=i([]),h=i(!1),K=i([]),S=i(0),T=i([]),p=A({pageNum:1,pageSize:10,code:""}),z=i([]),v=A({visible:!1});let F="",k=[],g=[],P=[];const r=A({code:"",remark:"",menuCheckStrictly:!1}),b=i(),ae=A({code:[{required:!0,message:"请输入角色编码",trigger:["blur"]},{validator:function(t,e,n){/^[a-zA-Z][a-zA-Z0-9_]*$/.test(e)?n():n(new Error("角色只能以字母开头, 并且只能包含字母、数字、_"))}}]});i(!1),i(!1),i();const L=i(!1),I=i(!1),x=i(null);le({menu:x});async function R(){h.value=!0;const{error:t,data:e}=await J.query({operationName:"System/Role/GetList",input:Ee(p,{containsFields:["code","remark"]})});t||(z.value=e.data,S.value=e.total),h.value=!1}function U(){q.value.resetFields(),p.pageNum=1,R()}function te(t){K.value=t.map(e=>e.id)}function j(t){F="dialog-from-right",v.visible=!0,t?(v.title="修改角色",Ne(r,t),b.value=t.id,ie(t.id)):(b.value=0,X(1).then(e=>{V.value=e.data.menus,k=[]}),v.title="新增角色")}async function oe(t){h.value=!0,N.value.validate(async e=>{if(e)if(b.value){const n=[],d=[];g.forEach(s=>{k.includes(s)||n.push(s)}),k.forEach(s=>{g.includes(s)||d.push(s)}),n.length&&await Y(t,b.value,n),d.length&&await ee(t,b.value,d),!n.length&&!d.length?(C.warning("您没有做任何修改"),E()):Se($.roles).then(s=>{$.SET_PERMISSIONS(s.data),C.success("修改成功"),E(),U()})}else if(z.value.some(d=>d.code===r.code))C.warning("该角色已存在,请勿重复添加");else{const{data:d,error:s}=await J.mutate({operationName:"System/Role/AddOne",input:{...r}}),_=[],m=[];g.forEach(y=>{k.includes(y)||_.push(y)}),k.forEach(y=>{g.includes(y)||m.push(y)}),_.length&&await Y(t,d.data.id,_),m.length&&await ee(t,d.data.id,m),s||(C.success("新增成功"),E(),U())}}),h.value=!1}function E(){F="dialog-leave",v.visible=!1,ne()}function ne(){N.value.resetFields(),N.value.clearValidate(),r.code="",r.remark=""}function O(t){const e=t?[t]:K.value;if(!e){C.warning("请勾选删除项");return}xe.confirm("确认删除已选中的数据项?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{h.value=!0,Ie(e).then(n=>{n&&(C.success("删除成功"),U())}),h.value=!1})}function se(t){Ue(t).then(e=>{T.value=e.data.data.main_findManyrole[0]._join.main_findManyrole_user.map(n=>({Id:n._join.main_findManyuser[0].id,userName:n._join.main_findManyuser[0].name}))})}function de(){T.value.length=0}ye(()=>{R()});function ie(t){X(t).then(e=>(V.value=e.data.menus,k=e.data.checkedKeys,I.value=k.length===e.data.allKeys.length,P=e.data.allKeys,Re(()=>{e.data.checkedKeys.forEach(n=>{x.value.setChecked(n,!0)})}),e))}function re(t){let e=V.value;for(let n=0;n<e.length;++n)x.value.store.nodesMap[e[n].id].expanded=t}function ue(t){x.value.setCheckedNodes(t?V.value:[]),t?g=P:g=[]}function ce(t,e){g=e.checkedKeys,I.value=g.length===P.length}return(t,e)=>{const n=f("el-input"),d=f("el-form-item"),s=f("el-button"),_=f("Auth"),m=f("el-table-column"),y=f("el-table"),me=f("el-popover"),fe=f("el-card"),Q=f("el-checkbox"),pe=f("el-dialog"),ve=he("loading");return B(),ke("div",Ae,[Z("div",Me,[l(u(M),{ref_key:"queryFormRef",ref:q,model:p,inline:!0},{default:a(()=>[l(d,{prop:"code",label:"编码"},{default:a(()=>[l(n,{modelValue:p.code,"onUpdate:modelValue":e[0]||(e[0]=o=>p.code=o),placeholder:"角色编码",clearable:"",onKeyup:we(R,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),l(d,null,{default:a(()=>[l(s,{type:"primary",onClick:R},{default:a(()=>[l(u(w),{icon:"ep:search"}),c("搜索 ")]),_:1}),l(s,{onClick:U},{default:a(()=>[l(u(w),{icon:"ep:refresh"}),c("重置 ")]),_:1})]),_:1})]),_:1},8,["model"])]),l(fe,{shadow:"never"},{header:a(()=>[l(_,{value:"system:role:add"},{default:a(()=>[l(s,{type:"success",onClick:e[1]||(e[1]=o=>j())},{default:a(()=>[l(u(w),{icon:"ep:plus"}),c("新增 ")]),_:1})]),_:1}),l(_,{value:"system:role:remove"},{default:a(()=>[l(s,{type:"danger",disabled:K.value.length===0,onClick:e[2]||(e[2]=o=>O())},{default:a(()=>[l(u(w),{icon:"ep:delete"}),c("删除 ")]),_:1},8,["disabled"])]),_:1})]),default:a(()=>[Ce((B(),D(y,{ref:"dataTableRef",data:z.value,onSelectionChange:te,"highlight-current-row":"",border:""},{default:a(()=>[l(m,{type:"selection",width:"55",align:"center"}),l(m,{label:"角色编码",prop:"code",width:"200"}),l(m,{label:"角色描述",prop:"remark",width:"300"}),l(m,{fixed:"right",label:"操作",align:"center"},{default:a(o=>[l(_,{value:"system:role:edit"},{default:a(()=>[l(s,{type:"primary",size:"small",link:"",onClick:H=>j(o.row)},{default:a(()=>[l(u(w),{icon:"ep:edit"}),c("编辑 ")]),_:2},1032,["onClick"])]),_:2},1024),l(_,{value:"system:role:remove"},{default:a(()=>[l(s,{type:"primary",size:"small",link:"",onClick:H=>O(o.row.id)},{default:a(()=>[l(u(w),{icon:"ep:delete"}),c("删除 ")]),_:2},1032,["onClick"])]),_:2},1024),l(me,{placement:"bottom",trigger:"click",width:300,title:"用户信息",onBeforeEnter:H=>se(o.row.code),onAfterLeave:de},{reference:a(()=>[l(s,{type:"primary",size:"small",link:""},{default:a(()=>[c(" 查看用户 ")]),_:1})]),default:a(()=>[l(y,{data:T.value},{default:a(()=>[l(m,{width:"100",property:"Id",label:"编号",align:"center"}),l(m,{width:"200",property:"userName",label:"用户名",align:"center"})]),_:1},8,["data"])]),_:2},1032,["onBeforeEnter"])]),_:1})]),_:1},8,["data"])),[[ve,h.value]]),S.value>0?(B(),D(u(Ve),{key:0,total:S.value,"onUpdate:total":e[3]||(e[3]=o=>S.value=o),page:p.pageNum,"onUpdate:page":e[4]||(e[4]=o=>p.pageNum=o),limit:p.pageSize,"onUpdate:limit":e[5]||(e[5]=o=>p.pageSize=o),onPagination:R},null,8,["total","page","limit"])):W("",!0)]),_:1}),l(pe,{title:v.title,modelValue:v.visible,"onUpdate:modelValue":e[13]||(e[13]=o=>v.visible=o),width:"500px",onClose:E,class:be(u(F)),"show-close":!1,height:"100vh"},{footer:a(()=>[Z("div",Be,[l(s,{type:"primary",onClick:e[12]||(e[12]=o=>oe(r.code))},{default:a(()=>[c("确 定")]),_:1}),l(s,{onClick:E},{default:a(()=>[c("取 消")]),_:1})])]),default:a(()=>[l(u(M),{ref_key:"roleFormRef",ref:N,model:r,rules:ae,"label-width":"100px",class:"dialog-content-left"},{default:a(()=>[l(d,{label:"角色编码",prop:"code"},{default:a(()=>[l(n,{modelValue:r.code,"onUpdate:modelValue":e[6]||(e[6]=o=>r.code=o),readonly:!!b.value,placeholder:"请输入角色编码"},null,8,["modelValue","readonly"])]),_:1}),l(d,{label:"角色描述",prop:"remark"},{default:a(()=>[l(n,{modelValue:r.remark,"onUpdate:modelValue":e[7]||(e[7]=o=>r.remark=o),placeholder:"请输入角色描述"},null,8,["modelValue"])]),_:1}),v.title!=="新增角色"?(B(),D(d,{key:0,label:"菜单权限"},{default:a(()=>[l(Q,{modelValue:L.value,"onUpdate:modelValue":e[8]||(e[8]=o=>L.value=o),onChange:e[9]||(e[9]=o=>re(o))},{default:a(()=>[c("展开/折叠")]),_:1},8,["modelValue"]),l(Q,{modelValue:I.value,"onUpdate:modelValue":e[10]||(e[10]=o=>I.value=o),onChange:e[11]||(e[11]=o=>ue(o))},{default:a(()=>[c("全选/全不选")]),_:1},8,["modelValue"])]),_:1})):W("",!0),l(d,null,{default:a(()=>[l(u(G),{class:"tree-border",data:V.value,"show-checkbox":"",ref_key:"menu",ref:x,"node-key":"id","empty-text":"......",onCheck:ce,style:{display:"block"}},null,8,["data"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue","class"])])}}});export{De as default};
