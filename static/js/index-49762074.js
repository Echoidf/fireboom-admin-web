import{d as P,aC as ne,r as s,au as H,a as g,k as Q,c as $,w as l,b as A,f as T,i as e,e as y,m as K,l as w,aG as L,aB as M,a0 as z,o as ie,g as se,ax as I,aH as ue,ay as re,az as N,aA as de,D as ce,aD as pe}from"./index-1ea74710.js";import{a as S,c as me}from"./index-2ab825e1.js";import{m as fe}from"./index-adf42357.js";import{b as ve}from"./system-11ac3e2f.js";const _e={class:"dialog-footer"},ye={name:"roleBindApi"},J=P({...ye,props:{modelValue:{type:Boolean,default:!1},role:{type:Object},roles:{type:Array,required:!0}},emits:["update:modelValue"],setup(D,{emit:U}){const d=D,b=ne(),k=s(),p=s(!1),u=s([]),m=s([]);let f=[];function c(n){m.value=n.map(a=>+a.id)}function C(){U("update:modelValue",!1),p.value=!1,m.value=[],f=[]}async function v(){p.value=!0;const{error:n}=await S.mutate({operationName:"System/Role/BindRoleApis",input:{allRoles:d.roles.map(a=>a.code),apis:m.value,roleCode:d.role.code}});if(n)M.error("绑定失败"),p.value=!1;else{const a=b.roles;ve(a).then(i=>{b.SET_PERMISSIONS(i)}),M.success("绑定成功"),C()}}return H(async()=>{var n,a;if(d.modelValue&&((n=d.role)!=null&&n.code)){p.value=!0;const i=await S.query({operationName:"System/Operation/GetMany"});if(!i.error){u.value=i.data.data;const{error:_,data:R}=await S.query({operationName:"System/Role/GetRoleBindApis",input:{code:d.role.code}});if(!_){f=((a=R.data)==null?void 0:a.map(h=>h.id))??[],m.value=f;const V=u.value.filter(h=>f.includes(+h.id));for(const h of V)k.value.toggleRowSelection(h,!0)}}p.value=!1}}),(n,a)=>{const i=g("el-table-column"),_=g("el-button"),R=g("el-dialog"),V=Q("loading");return A(),$(R,{title:"绑定权限","model-value":D.modelValue,width:"600px","append-to-body":"","onUpdate:modelValue":a[0]||(a[0]=h=>n.$emit("update:modelValue",h)),onClose:C},{footer:l(()=>[T("span",_e,[e(_,{onClick:C},{default:l(()=>[y("取消")]),_:1}),e(_,{type:"primary",onClick:v},{default:l(()=>[y("确定")]),_:1})])]),default:l(()=>[K((A(),$(w(L),{data:u.value,ref_key:"tableRef",ref:k,onSelectionChange:c},{default:l(()=>[e(i,{type:"selection",width:"55",align:"center"}),e(i,{label:"路径",prop:"title"}),e(i,{label:"Method",align:"center",prop:"method"}),e(i,{label:"实时查询",align:"center",prop:"liveQuery"})]),_:1},8,["data"])),[[V,p.value]])]),_:1},8,["model-value"])}}}),ge={class:"dialog-footer"},be={name:"roleBindMenu"},W=P({...be,props:{modelValue:{type:Boolean,default:!1},role:{type:Object}},emits:["update:modelValue"],setup(D,{emit:U}){const d=D,b=s(),k=s(!1),p=s([]),u=s([]);let m=[];function f(v){u.value=v.map(n=>n.id)}function c(){U("update:modelValue",!1),k.value=!1,u.value=[],m=[]}async function C(){k.value=!0;for(const v of m)await S.mutate({operationName:"System/Role/DisconnectOneMenu",input:{id:d.role.id,menuId:v}});for(const v of u.value)await S.mutate({operationName:"System/Role/ConnectOneMenu",input:{id:d.role.id,menuId:v}});c(),M.success("绑定成功"),k.value=!1}return H(async()=>{var v,n;if(d.modelValue&&((v=d.role)!=null&&v.code)){k.value=!0;const a=await S.query({operationName:"System/Menu/GetMany",input:{in:[1,2]}});if(!a.error){p.value=a.data.data;const{error:i,data:_}=await S.query({operationName:"System/Role/GetBindMenus",input:{roleId:d.role.id}});if(!i){m=((n=_.data)==null?void 0:n.map(V=>V.id))??[],u.value=m;const R=p.value.filter(V=>m.includes(V.id));for(const V of R)b.value.toggleRowSelection(V,!0)}}k.value=!1}}),(v,n)=>{const a=g("el-table-column"),i=g("el-button"),_=g("el-dialog"),R=Q("loading");return A(),$(_,{title:"绑定菜单","model-value":D.modelValue,width:"600px","append-to-body":"","onUpdate:modelValue":n[0]||(n[0]=V=>v.$emit("update:modelValue",V)),onClose:c},{footer:l(()=>[T("span",ge,[e(i,{onClick:c},{default:l(()=>[y("取消")]),_:1}),e(i,{type:"primary",onClick:C},{default:l(()=>[y("确定")]),_:1})])]),default:l(()=>[K((A(),$(w(L),{data:p.value,ref_key:"tableRef",ref:b,onSelectionChange:f},{default:l(()=>[e(a,{type:"selection",width:"55",align:"center"}),e(a,{label:"名称",prop:"label"}),e(a,{label:"路径",align:"center",prop:"path"})]),_:1},8,["data"])),[[R,k.value]])]),_:1},8,["model-value"])}}}),ke={class:"app-container"},Ve={class:"search"},we={class:"dialog-footer"},Re={name:"role",components:{RoleBindApi:J,RoleBindMenu:W}},Ne=P({...Re,name:"RoleManage",setup(D){const U=s(I),d=s(I);s(ue);const b=s(!1),k=s([]),p=s(0),u=z({pageNum:1,pageSize:10}),m=s([]),f=z({visible:!1}),c=z({code:"",remark:""}),C=s(),v=z({code:[{required:!0,message:"请输入角色编码",trigger:"blur"}]}),n=s(!1),a=s(!1),i=s();async function _(){b.value=!0;const{error:r,data:o}=await S.query({operationName:"System/Role/GetList",input:me(u,{containsFields:["code","remark"]})});r||(m.value=o.data,p.value=o.total),b.value=!1}function R(){U.value.resetFields(),u.pageNum=1,_()}function V(r){k.value=r.map(o=>o.id)}function h(r){f.visible=!0,r?(f.title="修改角色",fe(c,r),C.value=r.id):f.title="新增角色"}async function X(){b.value=!0,d.value.validate(async r=>{if(r){if(C.value){const{error:o}=await S.mutate({operationName:"System/Role/UpdateOne",input:{id:C.value,remark:c.remark}});o||(M.success("修改成功"),q(),R())}else{const{error:o}=await S.mutate({operationName:"System/Role/AddOne",input:{...c}});o||(M.success("新增成功"),q(),R())}b.value=!1}})}function q(){f.visible=!1,Y()}function Y(){d.value.resetFields(),d.value.clearValidate(),c.code="",c.remark=""}function j(r){const o=r?[r]:k;if(!o){M.warning("请勾选删除项");return}pe.confirm("确认删除已选中的数据项?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{b.value=!0;const{error:x}=await S.mutate({operationName:"System/Role/DeleteMany",input:{ids:o}});x||(M.success("删除成功"),R()),b.value=!1})}function Z(r){n.value=!0,i.value=r}function ee(r){a.value=!0,i.value=r}return ie(()=>{_()}),(r,o)=>{const x=g("el-input"),E=g("el-form-item"),B=g("el-button"),O=g("Auth"),F=g("el-table-column"),le=g("el-table"),oe=g("el-card"),te=g("el-dialog"),ae=Q("loading");return A(),se("div",ke,[T("div",Ve,[e(w(I),{ref_key:"queryFormRef",ref:U,model:u,inline:!0},{default:l(()=>[e(E,{prop:"code",label:"编码"},{default:l(()=>[e(x,{modelValue:u.code,"onUpdate:modelValue":o[0]||(o[0]=t=>u.code=t),placeholder:"角色编码",clearable:"",onKeyup:re(_,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),e(E,null,{default:l(()=>[e(B,{type:"primary",onClick:_},{default:l(()=>[e(w(N),{icon:"ep:search"}),y("搜索 ")]),_:1}),e(B,{onClick:R},{default:l(()=>[e(w(N),{icon:"ep:refresh"}),y("重置 ")]),_:1})]),_:1})]),_:1},8,["model"])]),e(oe,{shadow:"never"},{header:l(()=>[e(O,{value:"/System/Role/AddOne"},{default:l(()=>[e(B,{type:"success",onClick:o[1]||(o[1]=t=>h())},{default:l(()=>[e(w(N),{icon:"ep:plus"}),y("新增 ")]),_:1})]),_:1}),e(O,{value:"/System/Role/DeleteOne"},{default:l(()=>[e(B,{type:"danger",disabled:k.value.length===0,onClick:o[2]||(o[2]=t=>j())},{default:l(()=>[e(w(N),{icon:"ep:delete"}),y("删除 ")]),_:1},8,["disabled"])]),_:1})]),default:l(()=>[K((A(),$(le,{ref:"dataTableRef",data:m.value,onSelectionChange:V,"highlight-current-row":"",border:""},{default:l(()=>[e(F,{type:"selection",width:"55",align:"center"}),e(F,{label:"角色编码",prop:"code",width:"200"}),e(F,{label:"角色描述",prop:"remark",width:"300"}),e(F,{fixed:"right",label:"操作"},{default:l(t=>[e(O,{value:"/System/Role/BindRoleApis"},{default:l(()=>[e(B,{type:"primary",size:"small",link:"",onClick:G=>Z(t.row)},{default:l(()=>[e(w(N),{icon:"ep:position"}),y("分配权限 ")]),_:2},1032,["onClick"])]),_:2},1024),e(B,{type:"primary",size:"small",link:"",onClick:G=>ee(t.row)},{default:l(()=>[e(w(N),{icon:"ep:position"}),y("分配菜单 ")]),_:2},1032,["onClick"]),e(O,{value:"/System/Role/UpdateOne"},{default:l(()=>[e(B,{type:"primary",size:"small",link:"",onClick:G=>h(t.row)},{default:l(()=>[e(w(N),{icon:"ep:edit"}),y("编辑 ")]),_:2},1032,["onClick"])]),_:2},1024),e(O,{value:"/System/Role/DeleteMany"},{default:l(()=>[e(B,{type:"primary",size:"small",link:"",onClick:G=>j(t.row.id)},{default:l(()=>[e(w(N),{icon:"ep:delete"}),y("删除 ")]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ae,b.value]]),p.value>0?(A(),$(w(de),{key:0,total:p.value,"onUpdate:total":o[3]||(o[3]=t=>p.value=t),page:u.pageNum,"onUpdate:page":o[4]||(o[4]=t=>u.pageNum=t),limit:u.pageSize,"onUpdate:limit":o[5]||(o[5]=t=>u.pageSize=t),onPagination:_},null,8,["total","page","limit"])):ce("",!0)]),_:1}),e(te,{title:f.title,modelValue:f.visible,"onUpdate:modelValue":o[8]||(o[8]=t=>f.visible=t),width:"500px",onClose:q},{footer:l(()=>[T("div",we,[e(B,{type:"primary",onClick:X},{default:l(()=>[y("确 定")]),_:1}),e(B,{onClick:q},{default:l(()=>[y("取 消")]),_:1})])]),default:l(()=>[e(w(I),{ref_key:"roleFormRef",ref:d,model:c,rules:v,"label-width":"100px"},{default:l(()=>[e(E,{label:"角色编码",prop:"code"},{default:l(()=>[e(x,{modelValue:c.code,"onUpdate:modelValue":o[6]||(o[6]=t=>c.code=t),readonly:!!C.value,placeholder:"请输入角色编码"},null,8,["modelValue","readonly"])]),_:1}),e(E,{label:"角色描述",prop:"remark"},{default:l(()=>[e(x,{modelValue:c.remark,"onUpdate:modelValue":o[7]||(o[7]=t=>c.remark=t),placeholder:"请输入角色描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"]),e(J,{modelValue:n.value,"onUpdate:modelValue":o[9]||(o[9]=t=>n.value=t),role:i.value,roles:m.value},null,8,["modelValue","role","roles"]),e(W,{modelValue:a.value,"onUpdate:modelValue":o[10]||(o[10]=t=>a.value=t),role:i.value},null,8,["modelValue","role"])])}}});export{Ne as default};
